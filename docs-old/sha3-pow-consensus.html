<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sha3 Pow Consensus Algorithms - Substrate Recipes</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A Hands-On Cookbook for Aspiring Blockchain Chefs">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="pallets-intro.html"><strong aria-hidden="true">1.</strong> Pallets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="runtime-printing.html"><strong aria-hidden="true">1.1.</strong> Printing to the Node Log</a></li><li class="chapter-item expanded "><a href="events.html"><strong aria-hidden="true">1.2.</strong> Emitting Events</a></li><li class="chapter-item expanded "><a href="storage-maps.html"><strong aria-hidden="true">1.3.</strong> Storage Maps</a></li><li class="chapter-item expanded "><a href="cache.html"><strong aria-hidden="true">1.4.</strong> Cache Locally &gt; Storage Calls</a></li><li class="chapter-item expanded "><a href="vec-set.html"><strong aria-hidden="true">1.5.</strong> Using Vectors as Sets</a></li><li class="chapter-item expanded "><a href="map-set.html"><strong aria-hidden="true">1.6.</strong> Using Maps as Sets</a></li><li class="chapter-item expanded "><a href="double.html"><strong aria-hidden="true">1.7.</strong> Subgroup Removal by Subkey: Double Maps</a></li><li class="chapter-item expanded "><a href="structs.html"><strong aria-hidden="true">1.8.</strong> Storing custom structs</a></li><li class="chapter-item expanded "><a href="ringbuffer.html"><strong aria-hidden="true">1.9.</strong> Ringbuffer Queue</a></li><li class="chapter-item expanded "><a href="basic-token.html"><strong aria-hidden="true">1.10.</strong> Basic Token</a></li><li class="chapter-item expanded "><a href="constants.html"><strong aria-hidden="true">1.11.</strong> Configurable Constants</a></li><li class="chapter-item expanded "><a href="crowdfund.html"><strong aria-hidden="true">1.12.</strong> Simple Crowdfund</a></li><li class="chapter-item expanded "><a href="instantiable.html"><strong aria-hidden="true">1.13.</strong> Instantiable Pallets</a></li><li class="chapter-item expanded "><a href="weights.html"><strong aria-hidden="true">1.14.</strong> Weights for Resource Accounting</a></li><li class="chapter-item expanded "><a href="charity.html"><strong aria-hidden="true">1.15.</strong> Charity and Imbalances</a></li><li class="chapter-item expanded "><a href="fixed-point.html"><strong aria-hidden="true">1.16.</strong> Fixed Point Arithmetic</a></li><li class="chapter-item expanded "><a href="off-chain-workers/index.html"><strong aria-hidden="true">1.17.</strong> Off-chain Workers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="off-chain-workers/transactions.html"><strong aria-hidden="true">1.17.1.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="off-chain-workers/http-json.html"><strong aria-hidden="true">1.17.2.</strong> HTTP Fetching &amp; JSON Parsing</a></li><li class="chapter-item expanded "><a href="off-chain-workers/storage.html"><strong aria-hidden="true">1.17.3.</strong> Local Storage</a></li><li class="chapter-item expanded "><a href="off-chain-workers/indexing.html"><strong aria-hidden="true">1.17.4.</strong> Off-chain Indexing</a></li></ol></li><li class="chapter-item expanded "><a href="currency.html"><strong aria-hidden="true">1.18.</strong> Currency Types</a></li><li class="chapter-item expanded "><a href="currency-imbalances.html"><strong aria-hidden="true">1.19.</strong> Currency and Imbalances</a></li><li class="chapter-item expanded "><a href="randomness.html"><strong aria-hidden="true">1.20.</strong> Generating Randomness</a></li><li class="chapter-item expanded "><a href="pallet-coupling.html"><strong aria-hidden="true">1.21.</strong> Tightly- and Loosely-Coupled Pallets</a></li></ol></li><li class="chapter-item expanded "><a href="runtimes-intro.html"><strong aria-hidden="true">2.</strong> Runtimes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="runtime-api.html"><strong aria-hidden="true">2.1.</strong> Runtime APIs</a></li><li class="chapter-item expanded "><a href="fees.html"><strong aria-hidden="true">2.2.</strong> Transaction Fees for Economic Security</a></li></ol></li><li class="chapter-item expanded "><a href="consensus-intro.html"><strong aria-hidden="true">3.</strong> Consensus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sha3-pow-consensus.html" class="active"><strong aria-hidden="true">3.1.</strong> Sha3 Pow Consensus Algorithms</a></li></ol></li><li class="chapter-item expanded "><a href="nodes-intro.html"><strong aria-hidden="true">4.</strong> Nodes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kitchen-node.html"><strong aria-hidden="true">4.1.</strong> Kitchen Node - An reusable instant seal node</a></li><li class="chapter-item expanded "><a href="custom-rpc.html"><strong aria-hidden="true">4.2.</strong> Custom RPCs</a></li><li class="chapter-item expanded "><a href="basic-pow.html"><strong aria-hidden="true">4.3.</strong> Basic Proof of Work Node</a></li><li class="chapter-item expanded "><a href="hybrid-consensus.html"><strong aria-hidden="true">4.4.</strong> Hybrid PoW/PoS Consensus Node</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Substrate Recipes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sha3-proof-of-work-algorithms"><a class="header" href="#sha3-proof-of-work-algorithms">Sha3 Proof of Work Algorithms</a></h1>
<p><code>consensus/sha3-pow</code>
<a target="_blank" href="https://playground.substrate.dev/?deploy=recipes&files=%2Fhome%2Fsubstrate%2Fworkspace%2Fconsensus%2Fsha3-pow%2Fsrc%2Flib.rs">
<img src="https://img.shields.io/badge/Playground-Try%20it!-brightgreen?logo=Parity%20Substrate" alt ="Try on playground"/>
</a>
<a target="_blank" href="https://github.com/substrate-developer-hub/recipes/tree/master/consensus/sha3-pow/src/lib.rs">
<img src="https://img.shields.io/badge/Github-View%20Code-brightgreen?logo=github" alt ="View on GitHub"/>
</a></p>
<p><a href="https://en.wikipedia.org/wiki/Proof_of_work">Proof of Work</a> is not a single consensus algorithm.
Rather it is a class of algorithms represented in Substrate by the
<a href="https://substrate.dev/rustdocs/v3.0.0/sc_consensus_pow/trait.PowAlgorithm.html"><code>PowAlgorithm</code> trait</a>. Before we
can build a PoW node we must specify a concrete PoW algorithm by implementing this trait. In this
recipe we specify two concrete PoW algorithms, both of which are based on the
<a href="https://en.wikipedia.org/wiki/SHA-3">sha3 hashing algorithm</a>.</p>
<h2 id="minimal-sha3-pow"><a class="header" href="#minimal-sha3-pow">Minimal Sha3 PoW</a></h2>
<p>First we turn our attention to a minimal working implementation. This consensus engine is kept
intentionally simple. It omits some features that make Proof of Work practical for real-world use
such as difficulty adjustment.</p>
<p>Begin by creating a struct that will implement the <code>PowAlgorithm Trait</code>.</p>
<pre><code class="language-rust  ignore">/// A minimal PoW algorithm that uses Sha3 hashing.
/// Difficulty is fixed at 1_000_000
#[derive(Clone)]
pub struct MinimalSha3Algorithm;
</code></pre>
<p>Because this is a <em>minimal</em> PoW algorithm, our struct can also be quite simple. In fact, it is a
<a href="https://doc.rust-lang.org/rust-by-example/custom_types/structs.html">unit struct</a>. A more complex
PoW algorithm that interfaces with the runtime would need to hold a reference to the client. An
example of this (on an older Substrate codebase) can be seen in
<a href="https://github.com/kulupu/kulupu/">Kulupu</a>'s
<a href="https://github.com/kulupu/kulupu/blob/3500b7f62fdf90be7608b2d813735a063ad1c458/pow/src/lib.rs#L137-L145">RandomXAlgorithm</a>.</p>
<h3 id="difficulty"><a class="header" href="#difficulty">Difficulty</a></h3>
<p>The first function we must provide returns the difficulty of the next block to be mined. In our
minimal sha3 algorithm, this function is quite simple. The difficulty is fixed. This means that as
more mining power joins the network, the block time will become faster.</p>
<pre><code class="language-rust  ignore">impl&lt;B: BlockT&lt;Hash = H256&gt;&gt; PowAlgorithm&lt;B&gt; for MinimalSha3Algorithm {
	type Difficulty = U256;

	fn difficulty(&amp;self, _parent: B::Hash) -&gt; Result&lt;Self::Difficulty, Error&lt;B&gt;&gt; {
		// Fixed difficulty hardcoded here
		Ok(U256::from(1_000_000))
	}

	// --snip--
}
</code></pre>
<h3 id="verification"><a class="header" href="#verification">Verification</a></h3>
<p>Our PoW algorithm must also be able to verify blocks provided by other authors. We are first given
the pre-hash, which is a hash of the block before the proof of work seal is attached. We are also
given the seal, which testifies that the work has been done, and the difficulty that the block
author needed to meet. This function first confirms that the provided seal actually meets the target
difficulty, then it confirms that the seal is actually valid for the given pre-hash.</p>
<pre><code class="language-rust  ignore">fn verify(
	&amp;self,
	_parent: &amp;BlockId&lt;B&gt;,
	pre_hash: &amp;H256,
	_pre_digest: Option&lt;&amp;[u8]&gt;,
	seal: &amp;RawSeal,
	difficulty: Self::Difficulty,
) -&gt; Result&lt;bool, Error&lt;B&gt;&gt; {
	// Try to construct a seal object by decoding the raw seal given
	let seal = match Seal::decode(&amp;mut &amp;seal[..]) {
		Ok(seal) =&gt; seal,
		Err(_) =&gt; return Ok(false),
	};

	// See whether the hash meets the difficulty requirement. If not, fail fast.
	if !hash_meets_difficulty(&amp;seal.work, difficulty) {
		return Ok(false);
	}

	// Make sure the provided work actually comes from the correct pre_hash
	let compute = Compute {
		difficulty,
		pre_hash: *pre_hash,
		nonce: seal.nonce,
	};

	if compute.compute() != seal {
		return Ok(false);
	}

	Ok(true)
}
</code></pre>
<h2 id="realistic-sha3-pow"><a class="header" href="#realistic-sha3-pow">Realistic Sha3 PoW</a></h2>
<p>Having understood the fundamentals, we can now build a more realistic sha3 algorithm. The primary
difference here is that this algorithm will fetch the difficulty from the runtime via a
<a href="./runtime-api.html">runtime api</a>. This change allows the runtime to dynamically adjust the difficulty
based on block time. So if more mining power joins the network, the diffculty adjusts, and the
blocktime remains constant.</p>
<h3 id="defining-the-sha3algorithm-struct"><a class="header" href="#defining-the-sha3algorithm-struct">Defining the <code>Sha3Algorithm</code> Struct</a></h3>
<p>We begin as before by defining a struct that will implement the <code>PowAlgorithm</code> trait. Unlike before,
this struct must hold a reference to the
<a href="https://substrate.dev/rustdocs/v3.0.0/sc_service/client/struct.Client.html"><code>Client</code></a> so it can call the
appropriate runtime APIs.</p>
<pre><code class="language-rust  ignore">/// A complete PoW Algorithm that uses Sha3 hashing.
/// Needs a reference to the client so it can grab the difficulty from the runtime.
pub struct Sha3Algorithm&lt;C&gt; {
	client: Arc&lt;C&gt;,
}
</code></pre>
<p>Next we provide a <code>new</code> method for conveniently creating instances of our new struct.</p>
<pre><code class="language-rust  ignore">impl&lt;C&gt; Sha3Algorithm&lt;C&gt; {
	pub fn new(client: Arc&lt;C&gt;) -&gt; Self {
		Self { client }
	}
}
</code></pre>
<p>And finally we manually implement <code>Clone</code>. We cannot derive clone as we did for the
<code>MinimalSha3Algorithm</code>.</p>
<pre><code class="language-rust  ignore">// Manually implement clone. Deriving doesn't work because
// it'll derive impl&lt;C: Clone&gt; Clone for Sha3Algorithm&lt;C&gt;. But C in practice isn't Clone.
impl&lt;C&gt; Clone for Sha3Algorithm&lt;C&gt; {
	fn clone(&amp;self) -&gt; Self {
		Self::new(self.client.clone())
	}
}
</code></pre>
<blockquote>
<p>It isn't critical to understand <em>why</em> the manual <code>Clone</code> implementation is necessary, just that it
is necessary.</p>
</blockquote>
<h3 id="implementing-the-powalgorithm-trait"><a class="header" href="#implementing-the-powalgorithm-trait">Implementing the <code>PowAlgorithm</code> trait</a></h3>
<p>As before we implement the <code>PowAlgorithm</code> trait for our <code>Sha3Algorithm</code>. This time we supply more
complex trait bounds to ensure that the encapsulated client actually provides
the <a href="https://substrate.dev/rustdocs/v3.0.0/sp_consensus_pow/trait.DifficultyApi.html"><code>DifficultyAPI</code></a> necessary
to fetch the PoW difficulty from the runtime.</p>
<pre><code class="language-rust  ignore">impl&lt;B: BlockT&lt;Hash = H256&gt;, C&gt; PowAlgorithm&lt;B&gt; for Sha3Algorithm&lt;C&gt;
where
	C: ProvideRuntimeApi&lt;B&gt;,
	C::Api: DifficultyApi&lt;B, U256&gt;,
{
	type Difficulty = U256;

	// --snip
}
</code></pre>
<p>The implementation of <code>PowAlgorithm</code>'s <code>difficulty</code> function, no longer returns a fixed value, but
rather calls into the runtime API which is guaranteed to exist because of the trait bounds. It also
maps any errors that may have occurred when using the API.</p>
<pre><code class="language-rust  ignore">fn difficulty(&amp;self, parent: B::Hash) -&gt; Result&lt;Self::Difficulty, Error&lt;B&gt;&gt; {
	let parent_id = BlockId::&lt;B&gt;::hash(parent);
	self.client
		.runtime_api()
		.difficulty(&amp;parent_id)
		.map_err(|err| {
			sc_consensus_pow::Error::Environment(
				format!(&quot;Fetching difficulty from runtime failed: {:?}&quot;, err)
			)
		})
}
</code></pre>
<p>The <code>verify</code> function is unchanged from the <code>MinimalSha3Algorithm</code> implementation.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="consensus-intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="nodes-intro.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="consensus-intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="nodes-intro.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src=".analytics/load.js"></script>
        <script type="text/javascript" src=".analytics/config.js"></script>
        <script type="text/javascript" src=".analytics/klaro.min.js"></script>


    </body>
</html>
